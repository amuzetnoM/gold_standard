<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>System Design — Full Workflow Map</title>
  <style>
    body{font-family:Inter, Arial, sans-serif;margin:0;overflow:hidden;background:#0f1724;color:#e6eef8}
    header{height:48px;display:flex;align-items:center;padding:6px 12px;background:#071029;border-bottom:1px solid rgba(255,255,255,0.03)}
    #search{margin-left:12px;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071029;color:inherit}
    #canvas{width:100vw;height:calc(100vh - 48px);}
    .node rect{fill:#07203a;stroke:#1f6feb;stroke-width:1.2}
    .node text{fill:#dbeafe;font-size:12px}
    .node.highlight rect{fill:#1e3a8a;stroke:#60a5fa;stroke-width:1.8}
    .edge{stroke:#94a3b8;stroke-width:1.2;fill:none;opacity:0.7}
    .overlay{position:fixed;right:12px;top:60px;width:360px;max-height:70vh;overflow:auto;background:#071029;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px}
    .badge{background:#0b1220;border-radius:4px;padding:4px 6px;margin-left:6px;color:#9fb0d9}
    .small{font-size:12px;color:#9fb0d9}
    .footer{position:fixed;left:12px;bottom:12px;color:#9fb0d9;font-size:12px}
    button{background:#0b2a4a;color:#dff0ff;border:none;padding:6px 8px;border-radius:6px;cursor:pointer}
  </style>
</head>
<body>
  <header>
    <strong>System Workflow Map</strong>
    <input id="search" placeholder="Search file or module" />
    <div class="badge" id="counts">nodes: 0 edges: 0</div>
    <div style="flex:1"></div>
    <button id="fitBtn">Fit</button>
  </header>
  <div id="canvas"></div>
  <div class="overlay" id="inspector" style="display:none"></div>
  <div class="footer">Single-file offline map — generated automatically</div>

  <script id="deps" type="application/json">
<!-- DEPS_JSON_PLACEHOLDER -->
  </script>

  <script>
  (async function(){
    // Try fetching a JSON file `deps_graph.json` relative to this HTML. If that fails (file:// limitations), fall back to the inline script content.
    async function loadData(){
      const inline = document.getElementById('deps').textContent.trim();
      try{
        const resp = await fetch('deps_graph.json');
        if(resp.ok) return await resp.json();
      }catch(_){/* ignore fetch failures */}
      try{ return JSON.parse(inline); }catch(e){ console.error('Failed to parse inline deps JSON', e); return {nodes:[], edges:[]}; }
    }

    const data = await loadData();
    const nodes = data.nodes || [];
    const edges = data.edges || [];
    document.getElementById('counts').textContent = `nodes: ${nodes.length} edges: ${edges.length}`;

    // Group nodes by top-level package (first module part or folder)
    function topGroup(n){
      const m = n.module || n.path;
      const top = (m||'').split('.')[0];
      return top || '_root';
    }
    const groups = {};
    nodes.forEach(n=>{ const g=topGroup(n); groups[g]=groups[g]||[]; groups[g].push(n); });
    const groupNames = Object.keys(groups).sort();

    // layout params
    const colW = 320, rowH = 36, pad = 24, nodeW = 300, nodeH = 28;
    const cols = groupNames.length;
    let maxRows = 0;
    groupNames.forEach(g=> maxRows = Math.max(maxRows, groups[g].length));
    const width = Math.max(window.innerWidth, cols * colW + 200);
    const height = Math.max(window.innerHeight-60, maxRows * rowH + 200);

    const svgNS = 'http://www.w3.org/2000/svg';
    const container = document.getElementById('canvas');
    const svg = document.createElementNS(svgNS,'svg');
    svg.setAttribute('width','100%'); svg.setAttribute('height','100%');
    svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
    svg.style.background = 'linear-gradient(180deg,#071429,#00121a)';
    container.appendChild(svg);

    // defs (arrow marker)
    const defs = document.createElementNS(svgNS,'defs');
    const marker = document.createElementNS(svgNS,'marker');
    marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8');
    marker.setAttribute('refX','6'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
    const path = document.createElementNS(svgNS,'path'); path.setAttribute('d','M0,0 L6,3 L0,6 z'); path.setAttribute('fill','#94a3b8');
    marker.appendChild(path); defs.appendChild(marker); svg.appendChild(defs);

    // create node positions
    const nodeByPath = {};
    groupNames.forEach((g,ci)=>{
      const list = groups[g];
      list.forEach((n,ri)=>{
        const x = pad + ci * colW + 10;
        const y = pad + ri * rowH + 10;
        nodeByPath[n.path] = Object.assign({}, n, {x,y,w:nodeW,h:nodeH,group:g,index:ri});
      });
    });

    // draw edges first
    edges.forEach(e=>{
      const s = nodeByPath[e.src];
      const d = nodeByPath[e.dst];
      if(!s || !d) return; // skip unresolved
      const line = document.createElementNS(svgNS,'path');
      const sx = s.x + s.w; const sy = s.y + s.h/2;
      const dx = d.x; const dy = d.y + d.h/2;
      const mx = (sx + dx)/2;
      const dstr = `M ${sx} ${sy} C ${mx} ${sy} ${mx} ${dy} ${dx} ${dy}`;
      line.setAttribute('d', dstr);
      line.setAttribute('class','edge');
      line.setAttribute('marker-end','url(#arrow)');
      svg.appendChild(line);
    });

    // draw nodes
    Object.values(nodeByPath).forEach(n=>{
      const g = document.createElementNS(svgNS,'g'); g.setAttribute('class','node'); g.setAttribute('transform',`translate(${n.x},${n.y})`);
      const r = document.createElementNS(svgNS,'rect'); r.setAttribute('width',n.w); r.setAttribute('height',n.h); r.setAttribute('rx',6);
      g.appendChild(r);
      const t = document.createElementNS(svgNS,'text'); t.setAttribute('x',8); t.setAttribute('y',n.h/2 + 4); t.textContent = n.path.split('/').slice(-1)[0];
      g.appendChild(t);
      g.addEventListener('click', ()=> showInspector(n));
      svg.appendChild(g);
    });

    // search
    const search = document.getElementById('search');
    search.addEventListener('input', ()=>{
      const q = search.value.trim().toLowerCase();
      document.querySelectorAll('.node').forEach(el=> el.classList.remove('highlight'));
      if(!q) return;
      Object.values(nodeByPath).forEach(n=>{
        if(n.path.toLowerCase().includes(q) || (n.module||'').toLowerCase().includes(q)){
          const sel = [...svg.querySelectorAll('.node')].find(g=> g.getAttribute('transform')===`translate(${n.x},${n.y})`);
          if(sel) sel.classList.add('highlight');
        }
      });
    });

    // inspector
    const inspector = document.getElementById('inspector');
    function showInspector(n){
      inspector.style.display = 'block';
      inspector.innerHTML = `<strong>${n.path}</strong><div class="small">module: ${n.module || ''}</div><div class="small">size: ${n.size} bytes</div><pre style="white-space:pre-wrap;background:#071425;padding:8px;margin-top:8px;border-radius:6px">${escapeHtml(n.first_line||'')}</pre>`;
    }
    function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

    // fit button
    document.getElementById('fitBtn').addEventListener('click', ()=>{
      svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
    });

    // pan/zoom
    let isP=false, startX=0, startY=0, vbX=0, vbY=0, vbW=width, vbH=height;
    svg.addEventListener('mousedown', e=>{ isP=true; startX=e.clientX; startY=e.clientY; });
    window.addEventListener('mousemove', e=>{ if(!isP) return; const dx=(startX-e.clientX); const dy=(startY-e.clientY); svg.setAttribute('viewBox', `${vbX+dx} ${vbY+dy} ${vbW} ${vbH}`); });
    window.addEventListener('mouseup', ()=>{ if(isP){ isP=false; const vb=svg.getAttribute('viewBox').split(' ').map(Number); vbX=vb[0]; vbY=vb[1]; } });
    svg.addEventListener('wheel', e=>{ e.preventDefault(); const delta = e.deltaY>0?1.1:0.9; vbW *= delta; vbH *= delta; svg.setAttribute('viewBox', `${vbX} ${vbY} ${vbW} ${vbH}`); });

    // enter -> open first matching inspector
    search.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const q=search.value.trim().toLowerCase(); const found = Object.values(nodeByPath).find(n=> n.path.toLowerCase().includes(q) || (n.module||'').toLowerCase().includes(q)); if(found) showInspector(found); } });

    svg.setAttribute('viewBox',`0 0 ${width} ${height}`);

  })();
  </script>
</body>
</html>
