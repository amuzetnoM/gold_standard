<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>System Design — Modes (Inlined)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f1720;--panel:#0b1220;--muted:#9aa6b2;--accent:#6ee7b7;--node:#0b2333;--edge:#2dd4bf}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071026 0%,#081426 100%);color:#e6eef6;font-family:Inter,system-ui,DejaVu Sans,Arial}
    .toolbar{display:flex;gap:8px;padding:10px;background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn.active{border-color:var(--accent);color:var(--accent)}
    #app{display:flex;flex-direction:column;height:calc(100% - 52px)}
    #canvas-wrap{flex:1;position:relative}
    svg{width:100%;height:100%;display:block}
    .inspect{position:absolute;right:12px;top:72px;background:linear-gradient(180deg,#071826,#06202a);border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px;width:320px;color:var(--muted);box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    .inspect h4{margin:0 0 8px 0;color:#fff;font-size:14px}
    .node{cursor:pointer}
    .node rect{rx:6;fill:var(--node);stroke:rgba(255,255,255,0.03)}
    .node text{fill:#dff7f0;font-size:12px;font-family:Segoe UI,Inter,Arial}
    .edge{stroke:var(--edge);stroke-opacity:0.95;fill:none}
    .legend{margin-left:auto;color:var(--muted);font-size:13px}
    .search{margin-left:8px;padding:6px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="modeDeps" class="btn active">With Deps</button>
    <button id="modeFlow" class="btn">Flow</button>
    <button id="fit" class="btn">Fit</button>
    <input id="search" class="search" placeholder="Search files or module" />
    <div class="legend">Nodes: <span id="countNodes">0</span> • Edges: <span id="countEdges">0</span></div>
  </div>
  <div id="app">
    <div id="canvas-wrap">
      <svg id="svgroot" viewBox="0 0 1600 900"></svg>
      <div class="inspect" id="inspect" style="display:none"></div>
    </div>
  </div>

  <script>
  // Inlined JSON data — generated by the extractor (trimmed sample for offline viewer)
  const DEPS = {
  "nodes": [
    {"path":"gold_standard/gui.py","size":45006,"module":"gold_standard.gui","first_line":"#!/usr/bin/env python3"},
    {"path":"gold_standard/main.py","size":104978,"module":"gold_standard.main","first_line":"#!/opt/python3.12/bin/python3.12"},
    {"path":"gold_standard/db_manager.py","size":107544,"module":"gold_standard.db_manager","first_line":"#!/usr/bin/env python3"},
    {"path":"herald/__main__.py","size":44346,"module":"herald.__main__","first_line":"\"\"\""},
    {"path":"tools/build_dependency_graph.py","size":8475,"module":"tools.build_dependency_graph","first_line":"#!/usr/bin/env python3"}
  ],
  "edges": [
    {"src":"herald/__main__.py","dst":"herald/connector/mt5_connector.py","import":"herald.connector.mt5_connector"},
    {"src":"herald/__main__.py","dst":"herald/__init__.py","import":"herald.data.layer"}
  ]
};

  </script>
  <script>
  (function(){
    const svg = document.getElementById('svgroot');
    const ns = 'http://www.w3.org/2000/svg';
    const modeDeps = document.getElementById('modeDeps');
    const modeFlow = document.getElementById('modeFlow');
    const fitBtn = document.getElementById('fit');
    const search = document.getElementById('search');
    const inspect = document.getElementById('inspect');
    const countNodes = document.getElementById('countNodes');
    const countEdges = document.getElementById('countEdges');

    let state = {mode:'deps',nodes:[],edges:[]};

    function clearSVG(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

    function renderDeps(){
      const data = DEPS;
      state.nodes = data.nodes.slice(); state.edges = data.edges.slice();
      countNodes.textContent = state.nodes.length; countEdges.textContent = state.edges.length;
      clearSVG();
      // group by top-level folder
      const groups = {};
      state.nodes.forEach(n=>{ const g = n.path.split('/')[0]||'.'; groups[g]=groups[g]||[]; groups[g].push(n); });
      const groupKeys = Object.keys(groups).sort();
      const svgW = 1600, svgH = 900; const colW = Math.max(220, Math.floor(svgW/groupKeys.length));
      const positions = {};
      groupKeys.forEach((g,ci)=>{
        const col = groups[g];
        col.forEach((n,ri)=>{
          const x = 60 + ci*colW; const y = 80 + ri*36;
          positions[n.path] = {x,y,w:200,h:28};
          drawNode(n,x,y,200,28);
        });
      });
      // edges
      state.edges.forEach(e=>{
        const s = positions[e.src], d = positions[e.dst];
        if(!s||!d) return;
        drawEdge(s.x+200, s.y+14, d.x, d.y+14, e.import || e.via);
      });
    }

    function renderFlow(){
      const data = FLOW;
      // compute distances from any entry_point (BFS)
      const nodesByPath = {}; data.nodes.forEach(n=>nodesByPath[n.path]=n);
      const adj = {};
      data.edges.forEach(e=>{ adj[e.src]=adj[e.src]||[]; adj[e.src].push(e.dst); });
      const dist = {}; const q = [];
      data.entry_points.forEach(ep=>{ dist[ep]=0; q.push(ep); });
      while(q.length){ const u=q.shift(); const next = adj[u]||[]; next.forEach(v=>{ if(dist[v]===undefined){ dist[v]=(dist[u]||0)+1; q.push(v); }}); }
      // group by layer
      const layers = {};
      Object.keys(nodesByPath).forEach(p=>{ const d = dist[p]===undefined?99:dist[p]; layers[d]=layers[d]||[]; layers[d].push(nodesByPath[p]); });
      const layerKeys = Object.keys(layers).map(Number).sort((a,b)=>a-b);
      clearSVG();
      const svgW = 1600; const svgH = 900; const layerSpacing = Math.max(120, Math.floor(svgH/(layerKeys.length+1)));
      const positions = {};
      layerKeys.forEach((lk,li)=>{
        const row = layers[lk]; const cols = row.length; const colW = Math.max(180, Math.floor((svgW-160)/Math.max(1,cols)));
        row.forEach((n,ci)=>{
          const x = 80 + ci*colW; const y = 40 + li*layerSpacing;
          positions[n.path] = {x,y,w:160,h:34}; drawNode(n,x,y,160,34);
        });
      });
      // edges
      data.edges.forEach(e=>{ const s = positions[e.src], d = positions[e.dst]; if(!s||!d) return; drawEdge(s.x+s.w, s.y+s.h/2, d.x, d.y+d.h/2, e.via); });
    }

    function drawNode(n,x,y,w,h){
      const g = document.createElementNS(ns,'g'); g.classList.add('node'); g.setAttribute('transform',`translate(${x},${y})`);
      const r = document.createElementNS(ns,'rect'); r.setAttribute('width',w); r.setAttribute('height',h); r.setAttribute('rx',6); r.setAttribute('fill','#062833');
      const t = document.createElementNS(ns,'text'); t.setAttribute('x',8); t.setAttribute('y',h/2+5); t.setAttribute('font-size',12);
      const short = shortenPath(n.path,28);
      t.textContent = short;
      g.appendChild(r); g.appendChild(t);
      g.addEventListener('click',()=>showInspect(n));
      svg.appendChild(g);
    }

    function drawEdge(x1,y1,x2,y2,label){
      const path = document.createElementNS(ns,'path'); path.classList.add('edge');
      const dx = Math.max(30, (x2-x1)/2);
      const d = `M ${x1} ${y1} C ${x1+dx} ${y1} ${x2-dx} ${y2} ${x2} ${y2}`;
      path.setAttribute('d',d); path.setAttribute('stroke','#24d39a'); path.setAttribute('stroke-width',1.6);
      svg.appendChild(path);
    }

    function shortenPath(p,max){ if(p.length<=max) return p; const start = p.split('/').slice(0,2).join('/'); return start + '/…/' + p.split('/').pop(); }

    function showInspect(n){ inspect.style.display='block'; inspect.innerHTML = `<h4>${n.path}</h4><div><strong>module:</strong> ${n.module||''}</div><div style="margin-top:8px;color:var(--muted);font-size:12px">${escapeHtml(n.first_line||'')}</div>`; }

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    modeDeps.addEventListener('click',()=>{ modeDeps.classList.add('active'); modeFlow.classList.remove('active'); state.mode='deps'; renderDeps(); });
    modeFlow.addEventListener('click',()=>{ modeFlow.classList.add('active'); modeDeps.classList.remove('active'); state.mode='flow'; renderFlow(); });
    fitBtn.addEventListener('click',()=>{ if(state.mode==='deps') renderDeps(); else renderFlow(); });
    search.addEventListener('input',()=>{ const q = search.value.trim().toLowerCase(); if(!q){ if(state.mode==='deps') renderDeps(); else renderFlow(); return;} clearSVG(); const items = (state.mode==='deps'?DEPS.nodes:FLOW.nodes).filter(n=>n.path.toLowerCase().includes(q)|| (n.module||'').toLowerCase().includes(q)); items.forEach((n,i)=>drawNode(n,60,60+i*36,400,28)); countNodes.textContent = items.length; countEdges.textContent = 0; });

    // initial
    renderDeps();
  })();
  </script>

</body>
</html>