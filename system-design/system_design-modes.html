<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>System Map â€” Modes</title>
<style>
body{margin:0;font-family:Inter,Arial;background:#071029;color:#e6eef8}
.header{height:52px;display:flex;align-items:center;padding:8px 12px;background:#041223}
.btn{margin-left:8px;padding:6px 10px;border-radius:6px;border:none;background:#0b2a4a;color:#dff0ff;cursor:pointer}
#canvas{width:100vw;height:calc(100vh - 52px)}
.overlay{position:fixed;right:12px;top:64px;width:360px;max-height:70vh;overflow:auto;background:#071029;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px}
.node rect{fill:#07203a;stroke:#1f6feb;stroke-width:1.2}
.node text{fill:#dbeafe;font-size:12px}
.edge{stroke:#94a3b8;stroke-width:1.2;fill:none;opacity:0.8}
.node.highlight rect{fill:#1e3a8a;stroke:#60a5fa}
</style>
</head>
<body>
<div class="header">
  <strong style="margin-right:12px">System Map</strong>
  <button id="modeDeps" class="btn">With Deps</button>
  <button id="modeFlow" class="btn">Without Deps (Flow)</button>
  <input id="search" placeholder="search" style="margin-left:12px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#0b1b2a;color:#dff0ff" />
  <div style="flex:1"></div>
  <button id="fitBtn" class="btn">Fit</button>
</div>
<div id="canvas"></div>
<div id="inspector" class="overlay" style="display:none"></div>

<script>
async function loadJSON(path){ try{ const r=await fetch(path); if(r.ok) return await r.json(); }catch(e){} return null; }

let deps = await loadJSON('deps_graph.json');
let flow = await loadJSON('flow_graph.json');
if(!deps) deps = {nodes:[], edges:[]};
if(!flow) flow = {nodes:[], edges:[]};

const canvas = document.getElementById('canvas');
let svg, nodeByPath = {}, current = 'deps';

function render(data){
  // clear
  canvas.innerHTML = '';
  nodeByPath = {};
  const nodes = data.nodes || [];
  const edges = data.edges || [];
  // group by top-level
  const groups = {};
  nodes.forEach(n=>{ const top=(n.module||n.path||'').split('.')[0]||'_root'; (groups[top]=groups[top]||[]).push(n); });
  const groupNames = Object.keys(groups).sort();
  const colW = 320, rowH = 36, pad=24, nodeW=300, nodeH=28;
  let maxRows=0; groupNames.forEach(g=> maxRows=Math.max(maxRows, groups[g].length));
  const width = Math.max(window.innerWidth, groupNames.length*colW + 200);
  const height = Math.max(window.innerHeight-60, maxRows*rowH + 200);
  svg = document.createElementNS('http://www.w3.org/2000/svg','svg'); svg.setAttribute('width','100%'); svg.setAttribute('height','100%'); svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
  canvas.appendChild(svg);
  // defs arrow
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const marker = document.createElementNS('http://www.w3.org/2000/svg','marker'); marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','8'); marker.setAttribute('markerHeight','8'); marker.setAttribute('refX','6'); marker.setAttribute('refY','3'); marker.setAttribute('orient','auto');
  const p = document.createElementNS('http://www.w3.org/2000/svg','path'); p.setAttribute('d','M0,0 L6,3 L0,6 z'); p.setAttribute('fill','#94a3b8'); marker.appendChild(p); defs.appendChild(marker); svg.appendChild(defs);
  // positions
  groupNames.forEach((g,ci)=>{ groups[g].forEach((n,ri)=>{ const x=pad+ci*colW+10; const y=pad+ri*rowH+10; nodeByPath[n.path]=Object.assign({}, n,{x,y,w:nodeW,h:nodeH,group:g}); }); });
  // edges
  edges.forEach(e=>{ const s=nodeByPath[e.src]; const d=nodeByPath[e.dst]; if(!s||!d) return; const sx=s.x+s.w; const sy=s.y+s.h/2; const dx=d.x; const dy=d.y+d.h/2; const mx=(sx+dx)/2; const pathD=`M ${sx} ${sy} C ${mx} ${sy} ${mx} ${dy} ${dx} ${dy}`; const el=document.createElementNS('http://www.w3.org/2000/svg','path'); el.setAttribute('d',pathD); el.setAttribute('class','edge'); el.setAttribute('marker-end','url(#arrow)'); svg.appendChild(el); });
  // nodes
  Object.values(nodeByPath).forEach(n=>{ const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('class','node'); g.setAttribute('transform',`translate(${n.x},${n.y})`); const r=document.createElementNS('http://www.w3.org/2000/svg','rect'); r.setAttribute('width',n.w); r.setAttribute('height',n.h); r.setAttribute('rx',6); g.appendChild(r); const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',8); t.setAttribute('y',n.h/2+4); t.textContent=n.path.split('/').slice(-1)[0]; g.appendChild(t); g.addEventListener('click',()=>showInspector(n)); svg.appendChild(g); });
  svg.setAttribute('viewBox',`0 0 ${width} ${height}`);
}

function showInspector(n){ const ins=document.getElementById('inspector'); ins.style.display='block'; ins.innerHTML=`<strong>${n.path}</strong><div class="small">module: ${n.module||''}</div><div class="small">size: ${n.size}</div><pre style="white-space:pre-wrap;background:#071425;padding:8px;margin-top:8px;border-radius:6px">${(n.first_line||'')}</pre>`; }

// initial render
render(deps);

document.getElementById('modeDeps').addEventListener('click', ()=>{ current='deps'; render(deps); });
document.getElementById('modeFlow').addEventListener('click', ()=>{ current='flow'; render(flow); });
document.getElementById('fitBtn').addEventListener('click', ()=>{ if(svg) svg.setAttribute('viewBox', svg.getAttribute('viewBox')); });

// search
const search = document.getElementById('search'); search.addEventListener('input', ()=>{ const q=search.value.trim().toLowerCase(); document.querySelectorAll('.node').forEach(el=>el.classList.remove('highlight')); if(!q) return; Object.values(nodeByPath).forEach(n=>{ if(n.path.toLowerCase().includes(q)||(n.module||'').toLowerCase().includes(q)){ const sel=[...svg.querySelectorAll('.node')].find(g=>g.getAttribute('transform')===`translate(${n.x},${n.y})`); if(sel) sel.classList.add('highlight'); } }); });

</script>
</body>
</html>